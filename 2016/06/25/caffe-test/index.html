<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79896728-2', 'auto');
  ga('send', 'pageview');

</script>

  <title>利用 pycaffe API 训练神经网络 &middot; Puxuan</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|PT+Serif:400,400italic,700,700italic" type="text/css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <!-- <link rel="stylesheet" href="/public/css/jekyll-github.css"> -->
  <link rel="stylesheet" href="/public/css/styles/atelier-forest-light.css">
  <script src="/public/css/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- Insert to your webpage before the </head> -->
  <script src="/public/audioplayerengine/jquery.js"></script>
  <script src="/public/audioplayerengine/amazingaudioplayer.js"></script>
  <link rel="stylesheet" type="text/css" href="/public/audioplayerengine/initaudioplayer-1.css">
  <script src="/public/audioplayerengine/initaudioplayer-1.js"></script>
  <!-- End of head section HTML codes -->

  <link rel="canonical" href="http://puxuan.coding.me//2016/06/25/caffe-test/" />

  

  

  

  <style>
    .content a,
    .related-posts li a:hover {
      color: #949667;
    }
    ::selection {
      color: #fff;
      background: #949667;
    }
    ::-moz-selection {
      color: #fff;
      background: #949667;
    }
  </style>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Puxuan" href="http://puxuan.coding.me//atom.xml">

</head>


  <body>
    <a id="_menu" class="menu" href="#_sidebar">☰</a>

    <main class="content container">
      


<article class="post">
  <h1 class="post-title">利用 pycaffe API 训练神经网络</h1>
  <div class="post-date">
    <time datetime="2016-06-25T00:00:00+08:00">06/25/16</time>
    <span>on <a href="/tag/code/">Technique</a></span>
  </div>
  
  <hr/>
  <h1 id="section">导入依赖的模块</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">caffe</span>
<span class="n">caffe</span><span class="o">.</span><span class="n">set_mode_cpu</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">lmdb</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">StratifiedShuffleSplit</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre>
</div>

<h1 id="caffe---cuda-">查看服务器上的 caffe 配置 【事实上 CUDA 没有用到】</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span> <span class="s">"OS:     "</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span>
<span class="k">print</span> <span class="s">"Python: "</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span> <span class="s">"CUDA:   "</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">"nvcc"</span><span class="p">,</span><span class="s">"--version"</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">print</span> <span class="s">"LMDB:   "</span><span class="p">,</span> <span class="s">"."</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lmdb</span><span class="o">.</span><span class="n">version</span><span class="p">()])</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>OS:      Linux-3.13.0-65-generic-x86_64-with-Ubuntu-14.04-trusty
Python:  2.7.6 (default, Jun 22 2015, 17:58:13) 
CUDA:    Cuda compilation tools, release 5.5, V5.5.0
LMDB:    0.9.18
</code></pre>
</div>

<h1 id="section-1">切割训练集</h1>

<p>除去第一列和最后一列，其他都是特征</p>

<p>最后一列是标签 –&gt; 九种类 class1 - class9</p>

<p>第一列是编号 –&gt; 除去</p>

<h1 id="section-2">将特征值对数化</h1>

<p>x –&gt; log(x+1)</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'train.csv'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">","</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">vec_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">vec_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">str</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span> <span class="n">features</span>
<span class="k">print</span> <span class="s">'--------------------'</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">vec_log</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="k">print</span> <span class="n">features</span>

<span class="k">print</span> <span class="s">'===================='</span>

<span class="k">print</span> <span class="n">labels</span>
<span class="k">print</span> <span class="s">'--------------------'</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">vec_int</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="k">print</span> <span class="n">labels</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>[[ 1  0  0 ...,  0  0  0]
 [ 0  0  0 ...,  0  0  0]
 [ 0  0  0 ...,  0  0  0]
 ..., 
 [ 0  0  0 ...,  0  0  0]
 [ 1  0  0 ...,  3 10  0]
 [ 0  0  0 ...,  0  2  0]]
--------------------
[[ 0.69314718  0.          0.         ...,  0.          0.          0.        ]
 [ 0.          0.          0.         ...,  0.          0.          0.        ]
 [ 0.          0.          0.         ...,  0.          0.          0.        ]
 ..., 
 [ 0.          0.          0.         ...,  0.          0.          0.        ]
 [ 0.69314718  0.          0.         ...,  1.38629436  2.39789527  0.        ]
 [ 0.          0.          0.         ...,  0.          1.09861229  0.        ]]
====================
['Class_1' 'Class_1' 'Class_1' ..., 'Class_9' 'Class_9' 'Class_9']
--------------------
[0 0 0 ..., 8 8 8]
</code></pre>
</div>

<h1 id="section-3">将 训练集数据 和 测试集数据 按阶层 分离</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sss</span> <span class="o">=</span> <span class="n">StratifiedShuffleSplit</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sss</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">features_training</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">sss</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
<span class="n">labels_training</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">sss</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>

<span class="n">features_testing</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">sss</span><span class="p">[</span><span class="mi">1</span><span class="p">],]</span>
<span class="n">labels_testing</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">sss</span><span class="p">[</span><span class="mi">1</span><span class="p">],]</span>
</code></pre>
</div>

<h1 id="lmdb">将数据导进 LMDB</h1>

<p>实测装载的时候非常慢，大概用了五分钟</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_data_into_lmdb</span><span class="p">(</span><span class="n">lmdb_name</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">lmdb</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">lmdb_name</span><span class="p">,</span> <span class="n">map_size</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">nbytes</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">datum</span> <span class="o">=</span> <span class="n">caffe</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">caffe_pb2</span><span class="o">.</span><span class="n">Datum</span><span class="p">()</span>
        
        <span class="n">datum</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">datum</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">datum</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">datum</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="nb">float</span><span class="p">:</span> 
            <span class="n">datum</span><span class="o">.</span><span class="n">float_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"features.dtype unknown."</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">datum</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="n">str_id</span> <span class="o">=</span> <span class="s">'{:08}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
            <span class="n">txn</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">str_id</span><span class="p">,</span> <span class="n">datum</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">load_data_into_lmdb</span><span class="p">(</span><span class="s">"/root/jupyter/train_data_lmdb"</span><span class="p">,</span> <span class="n">features_training</span><span class="p">,</span> <span class="n">labels_training</span><span class="p">)</span>
<span class="n">load_data_into_lmdb</span><span class="p">(</span><span class="s">"/root/jupyter/test_data_lmdb"</span><span class="p">,</span> <span class="n">features_testing</span><span class="p">,</span> <span class="n">labels_testing</span><span class="p">)</span>
</code></pre>
</div>

<h1 id="lmdb-">检查 LMDB 内的数据是否正确</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_data_for_case_from_lmdb</span><span class="p">(</span><span class="n">lmdb_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">lmdb_env</span> <span class="o">=</span> <span class="n">lmdb</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">lmdb_name</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">lmdb_txn</span> <span class="o">=</span> <span class="n">lmdb_env</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

    <span class="n">raw_datum</span> <span class="o">=</span> <span class="n">lmdb_txn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">datum</span> <span class="o">=</span> <span class="n">caffe</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">caffe_pb2</span><span class="o">.</span><span class="n">Datum</span><span class="p">()</span>
    <span class="n">datum</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">raw_datum</span><span class="p">)</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">caffe</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">datum_to_array</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">datum</span><span class="o">.</span><span class="n">label</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">get_data_for_case_from_lmdb</span><span class="p">(</span><span class="s">"/root/jupyter/train_data_lmdb/"</span><span class="p">,</span> <span class="s">"00012345"</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>OUTPUT==============================</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>(2, array([[[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 1.79175949]],
 
        [[ 1.09861231]],
 
        [[ 1.38629436]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 1.38629436]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 1.38629436]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 1.09861231]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 1.38629436]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.69314718]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 1.09861231]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 2.39789534]],
 
        [[ 0.        ]],
 
        [[ 2.70805025]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]],
 
        [[ 0.        ]],
 
        [[ 0.69314718]],
 
        [[ 0.        ]]]))
</code></pre>
</div>

<h1 id="section-4">训练模型</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="p">[</span><span class="s">"/root/caffe/build/tools/caffe"</span><span class="p">,</span><span class="s">"train"</span><span class="p">,</span><span class="s">"--solver=config.prototxt"</span><span class="p">],</span> 
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span> <span class="n">res</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>I0625 21:21:50.990250 19613 caffe.cpp:178] Use CPU.
I0625 21:21:50.990743 19613 solver.cpp:48] Initializing solver from parameters: 
test_iter: 100
test_interval: 10000
base_lr: 0.01
display: 10000
max_iter: 100000
lr_policy: "inv"
gamma: 0.0001
power: 0.75
momentum: 0.9
weight_decay: 0.0005
solver_mode: CPU
net: "model_train_test.prototxt"
I0625 21:21:50.990794 19613 solver.cpp:91] Creating training net from net file: model_train_test.prototxt
I0625 21:21:50.991129 19613 net.cpp:313] The NetState phase (0) differed from the phase (1) specified by a rule in layer simple
I0625 21:21:50.991161 19613 net.cpp:313] The NetState phase (0) differed from the phase (1) specified by a rule in layer accuracy
I0625 21:21:50.991237 19613 net.cpp:49] Initializing net from parameters: 
name: "otto"
state {
  phase: TRAIN
}
layer {
  name: "otto"
  type: "Data"
  top: "data"
  top: "label"
  include {
    phase: TRAIN
  }
  data_param {
    source: "train_data_lmdb"
    batch_size: 64
    backend: LMDB
  }
}
layer {
  name: "ip1"
  type: "InnerProduct"
  bottom: "data"
  top: "ip1"
  inner_product_param {
    num_output: 30
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "relu1"
  type: "ReLU"
  bottom: "ip1"
  top: "ip1"
}
layer {
  name: "ip2"
  type: "InnerProduct"
  bottom: "ip1"
  top: "ip2"
  inner_product_param {
    num_output: 9
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "loss"
  type: "SoftmaxWithLoss"
  bottom: "ip2"
  bottom: "label"
  top: "loss"
}
I0625 21:21:50.991331 19613 layer_factory.hpp:77] Creating layer otto
I0625 21:21:50.992022 19613 net.cpp:91] Creating Layer otto
I0625 21:21:50.992053 19613 net.cpp:399] otto -&gt; data
I0625 21:21:50.992209 19613 net.cpp:399] otto -&gt; label
I0625 21:21:50.992393 19615 db_lmdb.cpp:35] Opened lmdb train_data_lmdb
I0625 21:21:50.992591 19613 data_layer.cpp:41] output data size: 64,93,1,1
I0625 21:21:50.992703 19613 net.cpp:141] Setting up otto
I0625 21:21:50.992738 19613 net.cpp:148] Top shape: 64 93 1 1 (5952)
I0625 21:21:50.992756 19613 net.cpp:148] Top shape: 64 (64)
I0625 21:21:50.992764 19613 net.cpp:156] Memory required for data: 24064
I0625 21:21:50.992781 19613 layer_factory.hpp:77] Creating layer ip1
I0625 21:21:50.992805 19613 net.cpp:91] Creating Layer ip1
I0625 21:21:50.992822 19613 net.cpp:425] ip1 &lt;- data
I0625 21:21:50.992849 19613 net.cpp:399] ip1 -&gt; ip1
I0625 21:21:50.992956 19613 net.cpp:141] Setting up ip1
I0625 21:21:50.992977 19613 net.cpp:148] Top shape: 64 30 (1920)
I0625 21:21:50.992990 19613 net.cpp:156] Memory required for data: 31744
I0625 21:21:50.993027 19613 layer_factory.hpp:77] Creating layer relu1
I0625 21:21:50.993052 19613 net.cpp:91] Creating Layer relu1
I0625 21:21:50.993067 19613 net.cpp:425] relu1 &lt;- ip1
I0625 21:21:50.993083 19613 net.cpp:386] relu1 -&gt; ip1 (in-place)
I0625 21:21:50.993108 19613 net.cpp:141] Setting up relu1
I0625 21:21:50.993122 19613 net.cpp:148] Top shape: 64 30 (1920)
I0625 21:21:50.993135 19613 net.cpp:156] Memory required for data: 39424
I0625 21:21:50.993144 19613 layer_factory.hpp:77] Creating layer ip2
I0625 21:21:50.993160 19613 net.cpp:91] Creating Layer ip2
I0625 21:21:50.993173 19613 net.cpp:425] ip2 &lt;- ip1
I0625 21:21:50.993191 19613 net.cpp:399] ip2 -&gt; ip2
I0625 21:21:50.993227 19613 net.cpp:141] Setting up ip2
I0625 21:21:50.993243 19613 net.cpp:148] Top shape: 64 9 (576)
I0625 21:21:50.993258 19613 net.cpp:156] Memory required for data: 41728
I0625 21:21:50.993279 19613 layer_factory.hpp:77] Creating layer loss
I0625 21:21:50.993310 19613 net.cpp:91] Creating Layer loss
I0625 21:21:50.993335 19613 net.cpp:425] loss &lt;- ip2
I0625 21:21:50.993361 19613 net.cpp:425] loss &lt;- label
I0625 21:21:50.993391 19613 net.cpp:399] loss -&gt; loss
I0625 21:21:50.993443 19613 layer_factory.hpp:77] Creating layer loss
I0625 21:21:50.993495 19613 net.cpp:141] Setting up loss
I0625 21:21:50.993518 19613 net.cpp:148] Top shape: (1)
I0625 21:21:50.993531 19613 net.cpp:151]     with loss weight 1
I0625 21:21:50.993563 19613 net.cpp:156] Memory required for data: 41732
I0625 21:21:50.993598 19613 net.cpp:217] loss needs backward computation.
I0625 21:21:50.993614 19613 net.cpp:217] ip2 needs backward computation.
I0625 21:21:50.993628 19613 net.cpp:217] relu1 needs backward computation.
I0625 21:21:50.993641 19613 net.cpp:217] ip1 needs backward computation.
I0625 21:21:50.993650 19613 net.cpp:219] otto does not need backward computation.
I0625 21:21:50.993662 19613 net.cpp:261] This network produces output loss
I0625 21:21:50.993686 19613 net.cpp:274] Network initialization done.
I0625 21:21:50.993988 19613 solver.cpp:181] Creating test net (#0) specified by net file: model_train_test.prototxt
I0625 21:21:50.994029 19613 net.cpp:313] The NetState phase (1) differed from the phase (0) specified by a rule in layer otto
I0625 21:21:50.994143 19613 net.cpp:49] Initializing net from parameters: 
name: "otto"
state {
  phase: TEST
}
layer {
  name: "simple"
  type: "Data"
  top: "data"
  top: "label"
  include {
    phase: TEST
  }
  data_param {
    source: "test_data_lmdb"
    batch_size: 100
    backend: LMDB
  }
}
layer {
  name: "ip1"
  type: "InnerProduct"
  bottom: "data"
  top: "ip1"
  inner_product_param {
    num_output: 30
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "relu1"
  type: "ReLU"
  bottom: "ip1"
  top: "ip1"
}
layer {
  name: "ip2"
  type: "InnerProduct"
  bottom: "ip1"
  top: "ip2"
  inner_product_param {
    num_output: 9
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "accuracy"
  type: "Accuracy"
  bottom: "ip2"
  bottom: "label"
  top: "accuracy"
  include {
    phase: TEST
  }
}
layer {
  name: "loss"
  type: "SoftmaxWithLoss"
  bottom: "ip2"
  bottom: "label"
  top: "loss"
}
I0625 21:21:50.994300 19613 layer_factory.hpp:77] Creating layer simple
I0625 21:21:50.994504 19613 net.cpp:91] Creating Layer simple
I0625 21:21:50.994531 19613 net.cpp:399] simple -&gt; data
I0625 21:21:50.994581 19613 net.cpp:399] simple -&gt; label
I0625 21:21:50.994736 19617 db_lmdb.cpp:35] Opened lmdb test_data_lmdb
I0625 21:21:50.994822 19613 data_layer.cpp:41] output data size: 100,93,1,1
I0625 21:21:50.994921 19613 net.cpp:141] Setting up simple
I0625 21:21:50.994968 19613 net.cpp:148] Top shape: 100 93 1 1 (9300)
I0625 21:21:50.995007 19613 net.cpp:148] Top shape: 100 (100)
I0625 21:21:50.995019 19613 net.cpp:156] Memory required for data: 37600
I0625 21:21:50.995035 19613 layer_factory.hpp:77] Creating layer label_simple_1_split
I0625 21:21:50.995079 19613 net.cpp:91] Creating Layer label_simple_1_split
I0625 21:21:50.995095 19613 net.cpp:425] label_simple_1_split &lt;- label
I0625 21:21:50.995136 19613 net.cpp:399] label_simple_1_split -&gt; label_simple_1_split_0
I0625 21:21:50.995157 19613 net.cpp:399] label_simple_1_split -&gt; label_simple_1_split_1
I0625 21:21:50.995282 19613 net.cpp:141] Setting up label_simple_1_split
I0625 21:21:50.995308 19613 net.cpp:148] Top shape: 100 (100)
I0625 21:21:50.995323 19613 net.cpp:148] Top shape: 100 (100)
I0625 21:21:50.995337 19613 net.cpp:156] Memory required for data: 38400
I0625 21:21:50.995352 19613 layer_factory.hpp:77] Creating layer ip1
I0625 21:21:50.995379 19613 net.cpp:91] Creating Layer ip1
I0625 21:21:50.995393 19613 net.cpp:425] ip1 &lt;- data
I0625 21:21:50.995412 19613 net.cpp:399] ip1 -&gt; ip1
I0625 21:21:50.995515 19613 net.cpp:141] Setting up ip1
I0625 21:21:50.995549 19613 net.cpp:148] Top shape: 100 30 (3000)
I0625 21:21:50.995573 19613 net.cpp:156] Memory required for data: 50400
I0625 21:21:50.995620 19613 layer_factory.hpp:77] Creating layer relu1
I0625 21:21:50.995649 19613 net.cpp:91] Creating Layer relu1
I0625 21:21:50.995679 19613 net.cpp:425] relu1 &lt;- ip1
I0625 21:21:50.995738 19613 net.cpp:386] relu1 -&gt; ip1 (in-place)
I0625 21:21:50.995769 19613 net.cpp:141] Setting up relu1
I0625 21:21:50.995801 19613 net.cpp:148] Top shape: 100 30 (3000)
I0625 21:21:50.995843 19613 net.cpp:156] Memory required for data: 62400
I0625 21:21:50.995867 19613 layer_factory.hpp:77] Creating layer ip2
I0625 21:21:50.995970 19613 net.cpp:91] Creating Layer ip2
I0625 21:21:50.995993 19613 net.cpp:425] ip2 &lt;- ip1
I0625 21:21:50.996019 19613 net.cpp:399] ip2 -&gt; ip2
I0625 21:21:50.996069 19613 net.cpp:141] Setting up ip2
I0625 21:21:50.996107 19613 net.cpp:148] Top shape: 100 9 (900)
I0625 21:21:50.996150 19613 net.cpp:156] Memory required for data: 66000
I0625 21:21:50.996211 19613 layer_factory.hpp:77] Creating layer ip2_ip2_0_split
I0625 21:21:50.996248 19613 net.cpp:91] Creating Layer ip2_ip2_0_split
I0625 21:21:50.996287 19613 net.cpp:425] ip2_ip2_0_split &lt;- ip2
I0625 21:21:50.996340 19613 net.cpp:399] ip2_ip2_0_split -&gt; ip2_ip2_0_split_0
I0625 21:21:50.996371 19613 net.cpp:399] ip2_ip2_0_split -&gt; ip2_ip2_0_split_1
I0625 21:21:50.996412 19613 net.cpp:141] Setting up ip2_ip2_0_split
I0625 21:21:50.996438 19613 net.cpp:148] Top shape: 100 9 (900)
I0625 21:21:50.996472 19613 net.cpp:148] Top shape: 100 9 (900)
I0625 21:21:50.996495 19613 net.cpp:156] Memory required for data: 73200
I0625 21:21:50.996522 19613 layer_factory.hpp:77] Creating layer accuracy
I0625 21:21:50.996582 19613 net.cpp:91] Creating Layer accuracy
I0625 21:21:50.996613 19613 net.cpp:425] accuracy &lt;- ip2_ip2_0_split_0
I0625 21:21:50.996639 19613 net.cpp:425] accuracy &lt;- label_simple_1_split_0
I0625 21:21:50.996666 19613 net.cpp:399] accuracy -&gt; accuracy
I0625 21:21:50.996717 19613 net.cpp:141] Setting up accuracy
I0625 21:21:50.996752 19613 net.cpp:148] Top shape: (1)
I0625 21:21:50.996790 19613 net.cpp:156] Memory required for data: 73204
I0625 21:21:50.996835 19613 layer_factory.hpp:77] Creating layer loss
I0625 21:21:50.996863 19613 net.cpp:91] Creating Layer loss
I0625 21:21:50.996892 19613 net.cpp:425] loss &lt;- ip2_ip2_0_split_1
I0625 21:21:50.996933 19613 net.cpp:425] loss &lt;- label_simple_1_split_1
I0625 21:21:50.996989 19613 net.cpp:399] loss -&gt; loss
I0625 21:21:50.997023 19613 layer_factory.hpp:77] Creating layer loss
I0625 21:21:50.997079 19613 net.cpp:141] Setting up loss
I0625 21:21:50.997107 19613 net.cpp:148] Top shape: (1)
I0625 21:21:50.997134 19613 net.cpp:151]     with loss weight 1
I0625 21:21:50.997189 19613 net.cpp:156] Memory required for data: 73208
I0625 21:21:50.997210 19613 net.cpp:217] loss needs backward computation.
I0625 21:21:50.997253 19613 net.cpp:219] accuracy does not need backward computation.
I0625 21:21:50.997300 19613 net.cpp:217] ip2_ip2_0_split needs backward computation.
I0625 21:21:50.997323 19613 net.cpp:217] ip2 needs backward computation.
I0625 21:21:50.997367 19613 net.cpp:217] relu1 needs backward computation.
I0625 21:21:50.997387 19613 net.cpp:217] ip1 needs backward computation.
I0625 21:21:50.997409 19613 net.cpp:219] label_simple_1_split does not need backward computation.
I0625 21:21:50.997452 19613 net.cpp:219] simple does not need backward computation.
I0625 21:21:50.997494 19613 net.cpp:261] This network produces output accuracy
I0625 21:21:50.997516 19613 net.cpp:261] This network produces output loss
I0625 21:21:50.997550 19613 net.cpp:274] Network initialization done.
I0625 21:21:50.997707 19613 solver.cpp:60] Solver scaffolding done.
I0625 21:21:50.997813 19613 caffe.cpp:219] Starting Optimization
I0625 21:21:50.997833 19613 solver.cpp:279] Solving otto
I0625 21:21:50.997851 19613 solver.cpp:280] Learning Rate Policy: inv
I0625 21:21:50.997876 19613 solver.cpp:337] Iteration 0, Testing net (#0)
I0625 21:21:50.997894 19613 net.cpp:684] Ignoring source layer otto
I0625 21:21:50.997928 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:51.147842 19613 solver.cpp:404]     Test net output #0: accuracy = 0.1248
I0625 21:21:51.147912 19613 solver.cpp:404]     Test net output #1: loss = 2.1982 (* 1 = 2.1982 loss)
I0625 21:21:51.148325 19613 solver.cpp:228] Iteration 0, loss = 2.2698
I0625 21:21:51.148362 19613 solver.cpp:244]     Train net output #0: loss = 2.2698 (* 1 = 2.2698 loss)
I0625 21:21:51.148388 19613 sgd_solver.cpp:106] Iteration 0, lr = 0.01
I0625 21:21:51.150216 19616 blocking_queue.cpp:50] Waiting for data
I0625 21:21:52.493607 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:53.902592 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:55.334097 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:56.728524 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:58.064667 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:21:59.485183 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:00.884795 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:02.292704 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:03.626282 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:05.040575 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:05.066630 19613 solver.cpp:337] Iteration 10000, Testing net (#0)
I0625 21:22:05.066674 19613 net.cpp:684] Ignoring source layer otto
I0625 21:22:05.280244 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7753
I0625 21:22:05.280333 19613 solver.cpp:404]     Test net output #1: loss = 0.562419 (* 1 = 0.562419 loss)
I0625 21:22:05.282181 19613 solver.cpp:228] Iteration 10000, loss = 0.590122
I0625 21:22:05.282222 19613 solver.cpp:244]     Train net output #0: loss = 0.590122 (* 1 = 0.590122 loss)
I0625 21:22:05.282241 19613 sgd_solver.cpp:106] Iteration 10000, lr = 0.00594604
I0625 21:22:06.532089 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:07.955276 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:09.373867 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:10.800011 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:12.222946 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:13.568476 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:15.948915 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:17.467255 19613 solver.cpp:337] Iteration 20000, Testing net (#0)
I0625 21:22:17.467306 19613 net.cpp:684] Ignoring source layer otto
I0625 21:22:17.662020 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7812
I0625 21:22:17.662123 19613 solver.cpp:404]     Test net output #1: loss = 0.537839 (* 1 = 0.537839 loss)
I0625 21:22:17.663969 19613 solver.cpp:228] Iteration 20000, loss = 0.592427
I0625 21:22:17.664058 19613 solver.cpp:244]     Train net output #0: loss = 0.592428 (* 1 = 0.592428 loss)
I0625 21:22:17.664093 19613 sgd_solver.cpp:106] Iteration 20000, lr = 0.00438691
I0625 21:22:18.922065 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:20.288331 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:21.661711 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:23.067240 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:24.482105 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:25.875449 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:27.257803 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:28.639379 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:30.058917 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:31.442282 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:31.614090 19613 solver.cpp:337] Iteration 30000, Testing net (#0)
I0625 21:22:31.614181 19613 net.cpp:684] Ignoring source layer otto
I0625 21:22:31.866688 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7818
I0625 21:22:31.866756 19613 solver.cpp:404]     Test net output #1: loss = 0.538419 (* 1 = 0.538419 loss)
I0625 21:22:31.867094 19613 solver.cpp:228] Iteration 30000, loss = 0.692108
I0625 21:22:31.867120 19613 solver.cpp:244]     Train net output #0: loss = 0.692108 (* 1 = 0.692108 loss)
I0625 21:22:31.867136 19613 sgd_solver.cpp:106] Iteration 30000, lr = 0.00353553
I0625 21:22:32.981786 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:35.036489 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:36.434914 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:37.834898 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:39.246500 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:40.623255 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:43.392879 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:44.135308 19613 solver.cpp:337] Iteration 40000, Testing net (#0)
I0625 21:22:44.135383 19613 net.cpp:684] Ignoring source layer otto
I0625 21:22:44.337389 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7928
I0625 21:22:44.337458 19613 solver.cpp:404]     Test net output #1: loss = 0.53659 (* 1 = 0.53659 loss)
I0625 21:22:44.337791 19613 solver.cpp:228] Iteration 40000, loss = 0.390615
I0625 21:22:44.337815 19613 solver.cpp:244]     Train net output #0: loss = 0.390615 (* 1 = 0.390615 loss)
I0625 21:22:44.337831 19613 sgd_solver.cpp:106] Iteration 40000, lr = 0.0029907
I0625 21:22:44.903179 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:46.322223 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:47.750073 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:49.180613 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:50.587481 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:52.227707 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:53.620036 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:54.959548 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:56.326694 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:57.680536 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:22:58.088132 19613 solver.cpp:337] Iteration 50000, Testing net (#0)
I0625 21:22:58.088203 19613 net.cpp:684] Ignoring source layer otto
I0625 21:22:58.325206 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7865
I0625 21:22:58.325284 19613 solver.cpp:404]     Test net output #1: loss = 0.533907 (* 1 = 0.533907 loss)
I0625 21:22:58.325626 19613 solver.cpp:228] Iteration 50000, loss = 0.642513
I0625 21:22:58.325660 19613 solver.cpp:244]     Train net output #0: loss = 0.642514 (* 1 = 0.642514 loss)
I0625 21:22:58.325677 19613 sgd_solver.cpp:106] Iteration 50000, lr = 0.00260847
I0625 21:22:59.167842 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:00.560353 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:01.929826 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:03.290251 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:07.543730 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:08.963755 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:10.141283 19613 solver.cpp:337] Iteration 60000, Testing net (#0)
I0625 21:23:10.141357 19613 net.cpp:684] Ignoring source layer otto
I0625 21:23:10.350092 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7946
I0625 21:23:10.350184 19613 solver.cpp:404]     Test net output #1: loss = 0.535143 (* 1 = 0.535143 loss)
I0625 21:23:10.351904 19613 solver.cpp:228] Iteration 60000, loss = 0.450416
I0625 21:23:10.351976 19613 solver.cpp:244]     Train net output #0: loss = 0.450416 (* 1 = 0.450416 loss)
I0625 21:23:10.352010 19613 sgd_solver.cpp:106] Iteration 60000, lr = 0.00232368
I0625 21:23:10.458317 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:12.985669 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:14.373915 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:15.772375 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:17.176959 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:18.591495 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:19.963181 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:21.361340 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:22.740375 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:23.460054 19613 solver.cpp:337] Iteration 70000, Testing net (#0)
I0625 21:23:23.460125 19613 net.cpp:684] Ignoring source layer otto
I0625 21:23:23.599720 19613 solver.cpp:404]     Test net output #0: accuracy = 0.791
I0625 21:23:23.599808 19613 solver.cpp:404]     Test net output #1: loss = 0.533403 (* 1 = 0.533403 loss)
I0625 21:23:23.600157 19613 solver.cpp:228] Iteration 70000, loss = 0.363449
I0625 21:23:23.600206 19613 solver.cpp:244]     Train net output #0: loss = 0.363449 (* 1 = 0.363449 loss)
I0625 21:23:23.600236 19613 sgd_solver.cpp:106] Iteration 70000, lr = 0.00210224
I0625 21:23:24.187052 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:25.582316 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:26.963722 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:28.352783 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:29.731739 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:31.132463 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:32.500038 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:33.900215 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:35.241858 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:36.645187 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:37.414625 19613 solver.cpp:337] Iteration 80000, Testing net (#0)
I0625 21:23:37.414719 19613 net.cpp:684] Ignoring source layer otto
I0625 21:23:37.563081 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7939
I0625 21:23:37.563172 19613 solver.cpp:404]     Test net output #1: loss = 0.532161 (* 1 = 0.532161 loss)
I0625 21:23:37.563555 19613 solver.cpp:228] Iteration 80000, loss = 0.46377
I0625 21:23:37.563609 19613 solver.cpp:244]     Train net output #0: loss = 0.46377 (* 1 = 0.46377 loss)
I0625 21:23:37.563650 19613 sgd_solver.cpp:106] Iteration 80000, lr = 0.0019245
I0625 21:23:38.120656 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:39.509018 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:40.907493 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:42.269062 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:43.672540 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:45.081641 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:46.490942 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:47.878592 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:49.282047 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:50.670797 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:51.471745 19613 solver.cpp:337] Iteration 90000, Testing net (#0)
I0625 21:23:51.471837 19613 net.cpp:684] Ignoring source layer otto
I0625 21:23:51.687338 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7948
I0625 21:23:51.687484 19613 solver.cpp:404]     Test net output #1: loss = 0.529078 (* 1 = 0.529078 loss)
I0625 21:23:51.689254 19613 solver.cpp:228] Iteration 90000, loss = 0.553851
I0625 21:23:51.689309 19613 solver.cpp:244]     Train net output #0: loss = 0.553851 (* 1 = 0.553851 loss)
I0625 21:23:51.689342 19613 sgd_solver.cpp:106] Iteration 90000, lr = 0.00177828
I0625 21:23:52.168859 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:53.557564 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:54.936652 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:56.309146 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:57.708384 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:23:59.085268 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:24:00.478286 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:24:01.886891 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:24:03.312654 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:24:04.737825 19613 blocking_queue.cpp:50] Data layer prefetch queue empty
I0625 21:24:05.632840 19613 solver.cpp:454] Snapshotting to binary proto file _iter_100000.caffemodel
I0625 21:24:05.633457 19613 sgd_solver.cpp:273] Snapshotting solver state to binary proto file _iter_100000.solverstate
I0625 21:24:05.634476 19613 solver.cpp:317] Iteration 100000, loss = 0.359318
I0625 21:24:05.634537 19613 solver.cpp:337] Iteration 100000, Testing net (#0)
I0625 21:24:05.634572 19613 net.cpp:684] Ignoring source layer otto
I0625 21:24:05.850015 19613 solver.cpp:404]     Test net output #0: accuracy = 0.7888
I0625 21:24:05.850111 19613 solver.cpp:404]     Test net output #1: loss = 0.531829 (* 1 = 0.531829 loss)
I0625 21:24:05.850168 19613 solver.cpp:322] Optimization Done.
I0625 21:24:05.850196 19613 caffe.cpp:222] Optimization Done.
</code></pre>
</div>

<h1 id="section-5">训练完成，现在来应用一下这个模型</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="n">caffe</span><span class="o">.</span><span class="n">Net</span><span class="p">(</span><span class="s">"model_prod.prototxt"</span><span class="p">,</span><span class="s">"./_iter_100000.caffemodel"</span><span class="p">,</span> <span class="n">caffe</span><span class="o">.</span><span class="n">TEST</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_data_for_case_from_lmdb</span><span class="p">(</span><span class="s">"/root/jupyter/test_data_lmdb/"</span><span class="p">,</span> <span class="s">"00001230"</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">net</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">f</span><span class="p">])})</span>

<span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">"prob"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">l</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">out</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="n">out</span><span class="p">[</span><span class="s">"prob"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>True 
{'prob': array([[ 0.00222289,  0.92165124,  0.0368802 ,  0.02282126,  0.00101307,
         0.0023116 ,  0.00770539,  0.0020058 ,  0.0033885 ]], dtype=float32)}





&lt;Container object of 9 artists&gt;
</code></pre>
</div>

<p><img src="/public/img/pycaffeTest/output_22_2.png" alt="png" /></p>

<h1 id="section-6">将神经网络图可视化</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">text_format</span>
<span class="kn">from</span> <span class="nn">caffe.draw</span> <span class="kn">import</span> <span class="n">get_pydot_graph</span>
<span class="kn">from</span> <span class="nn">caffe.proto</span> <span class="kn">import</span> <span class="n">caffe_pb2</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Image</span> 
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">_net</span> <span class="o">=</span> <span class="n">caffe_pb2</span><span class="o">.</span><span class="n">NetParameter</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"model_prod.prototxt"</span><span class="p">)</span>
<span class="n">text_format</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">_net</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">get_pydot_graph</span><span class="p">(</span><span class="n">_net</span><span class="p">,</span><span class="s">"TB"</span><span class="p">)</span><span class="o">.</span><span class="n">create_png</span><span class="p">()))</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<p><img src="/public/img/pycaffeTest/output_25_0.png" alt="png" /></p>

<h1 id="section-7">分量可视化</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">arr</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">"ip1"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'none'</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">"horizontal"</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>OUTPUT==============================</strong></p>

<p><img src="/public/img/pycaffeTest/output_28_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre>
</div>
<p><strong>OUTPUT==============================</strong></p>

<p><img src="/public/img/pycaffeTest/output_29_0.png" alt="png" /></p>

<hr />
<p>参考：
<a href="http://rayz0620.github.io/2015/05/25/lmdb_in_caffe/">Caffe中LMDB的使用</a></p>

</article>


<aside class="author">
  <h2 class="aside-title">About</h2>

  
  <img class="me" src="/public/img/profile.jpg" alt="Puxuan Yu"/>
  

  <p>Software Engineering @ WuhanU 🇨🇳 , ISTJ.</p>

</aside>


<aside class="related">
  <h2 class="aside-title">Related Posts</h2>
  <ul class="related-posts">
    
    
    
      
      
        <li>
          <h4>
            <a href="/2016/12/07/image-segmention/">
              <span>Efficient Graph-based Image Segmentation</span>
              <small>12/07/16</small>
            </a>
          </h4>
        </li>
      
    
      
      
        <li>
          <h4>
            <a href="/2016/11/11/intro-to-xgboost/">
              <span>XGBoost详解</span>
              <small>11/11/16</small>
            </a>
          </h4>
        </li>
      
    
      
      
        <li>
          <h4>
            <a href="/2016/10/28/nnfml1/">
              <span>机器学习中的神经网络-笔记(1)</span>
              <small>10/28/16</small>
            </a>
          </h4>
        </li>
      
    
      
      
    
  </ul>
</aside>


<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key='/2016/06/25/caffe-test' data-title="利用 pycaffe API 训练神经网络" data-url='http://puxuan.coding.me//2016/06/25/caffe-test/'></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"lucius0814"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


    </main>

    





<div   id="_backdrop" class="backdrop"></div>
<aside id="_sidebar" class="sidebar" style="background-image:url('/public/img/code.jpg')">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1><a href="/">Puxuan</a></h1>
      <p>10^14 synapses in a brain, and 10^9 seconds in a life.</p>

    </div>

    <nav class="sidebar-nav">
      <ul>
        
          
          <li>
            <a class="sidebar-nav-item " href="/tag/code/">Technique</a>
          </li>
        
          
          <li>
            <a class="sidebar-nav-item " href="/tag/travel/">Travel</a>
          </li>
        
          
          <li>
            <a class="sidebar-nav-item " href="/tag/music/">Music</a>
          </li>
        
          
          <li>
            <a class="sidebar-nav-item " href="/tag/other/">Misc</a>
          </li>
        

        

        
        
          
            
          
        
          
            
            <li>
              <a class="sidebar-nav-item " href="/about/">About</a>
            </li>
            
          
        
          
        
          
        
          
            
          
        
          
        
          
        
          
        
      </ul>
    </nav>

    <div class="sidebar-social">
      
        <a href="https://github.com/PxYu" target="_blank"><span class="icon-github"></span></a>

      

      
        <a href="https://instagram.com/pxyuwhu" target="_blank"><span class="icon-instagram"></span></a>

      

      
        <a href="https://twitter.com/pxyuwhu" target="_blank"><span class="icon-twitter-square"></span></a>

      

      
        <a href="https://facebook.com/martin.yu.5249" target="_blank"><span class="icon-facebook-square"></span></a>

      

      
        <a href="https://weibo.com/u/3290896193" target="_blank"><span class="icon-weibo"></span></a>

      


    </div>
  </div>
</aside>


    <script src="/public/js/hydejack.js" async></script>
  </body>
</html>
